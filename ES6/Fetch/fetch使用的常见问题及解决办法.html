<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3c.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

<title>fetch使用的常见问题及解决办法</title>
<!--defaultCSS-->
</head>

<body>
<div id="WizHtmlContentId">

<!--WizHtmlContentBegin--><div>-&nbsp;<a href="http://www.cnblogs.com/wonyun/p/fetch_polyfill_timeout_jsonp_cookie_progress.html">http://www.cnblogs.com/wonyun/p/fetch_polyfill_timeout_jsonp_cookie_progress.html</a>&nbsp;&nbsp;</div><div><br></div><div><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">首先声明一下，本文不是要讲解fetch的具体用法，不清楚的可以参考<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/GlobalFetch/fetch" style="margin: 0px; padding: 0px; color: rgb(0, 0, 0);">MDN fetch教程</a>。</p><h2 id="引言" style="margin-top: 20px; margin-bottom: 20px; font-size: 21px; line-height: 1.5; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">引言</h2><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">说道fetch就不得不提XMLHttpRequest了，XHR在发送web请求时需要开发者配置相关请求信息和成功后的回调，尽管开发者只关心请求成功后的业务处理，但是也要配置其他繁琐内容，导致配置和调用比较混乱，也不符合关注分离的原则；fetch的出现正是为了解决XHR存在的这些问题。例如下面代码：</p><div class="sourceCode" style="padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><pre class="sourceCode javascript" style="margin-top: 10px; margin-bottom: 10px; padding: 0px; white-space: pre-wrap; word-wrap: break-word;"><code class="sourceCode javascript hljs" style="margin: auto; vertical-align: middle; display: block; height: auto; overflow-x: auto; color: rgb(0, 0, 0); padding: 5px !important; line-height: 1.5 !important; font-family: 'Courier New', sans-serif !important; font-size: 12px !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><span class="at" style="margin: 0px; padding: 0px;">fetch</span>(url).<span class="at" style="margin: 0px; padding: 0px;">then</span>(<span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-function" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">function</span></span></span><span class="hljs-function" style="margin: 0px; padding: 0px;">(<span class="hljs-params" style="margin: 0px; padding: 0px;">response</span>) </span><span class="op" style="margin: 0px; padding: 0px;">{</span>
  <span class="cf" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">return</span></span> <span class="va" style="margin: 0px; padding: 0px;">response</span>.<span class="at" style="margin: 0px; padding: 0px;">json</span>()<span class="op" style="margin: 0px; padding: 0px;">;</span>
<span class="op" style="margin: 0px; padding: 0px;">}</span>).<span class="at" style="margin: 0px; padding: 0px;">then</span>(<span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-function" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">function</span></span></span><span class="hljs-function" style="margin: 0px; padding: 0px;">(<span class="hljs-params" style="margin: 0px; padding: 0px;">data</span>) </span><span class="op" style="margin: 0px; padding: 0px;">{</span>
  <span class="va" style="margin: 0px; padding: 0px;"><span class="hljs-built_in" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">console</span></span>.<span class="at" style="margin: 0px; padding: 0px;">log</span>(data)<span class="op" style="margin: 0px; padding: 0px;">;</span>
<span class="op" style="margin: 0px; padding: 0px;">}</span>).<span class="at" style="margin: 0px; padding: 0px;">catch</span>(<span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-function" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">function</span></span></span><span class="hljs-function" style="margin: 0px; padding: 0px;">(<span class="hljs-params" style="margin: 0px; padding: 0px;">e</span>) </span><span class="op" style="margin: 0px; padding: 0px;">{</span>
  <span class="va" style="margin: 0px; padding: 0px;"><span class="hljs-built_in" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">console</span></span>.<span class="at" style="margin: 0px; padding: 0px;">log</span>(<span class="st" style="margin: 0px; padding: 0px;"><span class="hljs-string" style="margin: 0px; padding: 0px; color: rgb(163, 21, 21);">"Oops, error"</span></span>)<span class="op" style="margin: 0px; padding: 0px;">;</span>
<span class="op" style="margin: 0px; padding: 0px;">}</span>)<span class="op" style="margin: 0px; padding: 0px;">;</span></code></pre></div><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">上面这段代码让开发者只关注请求成功后的业务逻辑处理，其他的不用关心，相当简单；也比较符合现代Promise形式，比较友好。</p><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><strong style="margin: 0px; padding: 0px;">fetch是基于Promise设计的</strong>，从上面代码也能看得出来，这就要求fetch要配合Promise一起使用。正是这种设计，fetch所带来的优点正如<a href="https://segmentfault.com/a/1190000003810652" style="margin: 0px; padding: 0px; color: rgb(0, 0, 0);">传统 Ajax 已死，Fetch 永生</a>总结的一样：</p><ul style="margin-bottom: 1em; margin-left: 40px; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><li style="padding: 0px; list-style-type: disc;"><p style="margin: 10px auto; padding: 0px;">语法简单，更加语义化</p></li><li style="padding: 0px; list-style-type: disc;"><p style="margin: 10px auto; padding: 0px;">基于标准的Promise实现，支持async/await</p></li><li style="padding: 0px; list-style-type: disc;"><p style="margin: 10px auto; padding: 0px;">使用<a href="https://github.com/matthew-andrews/isomorphic-fetch" style="margin: 0px; padding: 0px; color: rgb(0, 0, 0);"><code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">isomorphic-fetch</code></a>可以方便同构</p></li></ul><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">不过话说回来，fetch虽然有很多优点，但是使用fetch来进行项目开发时，也是有一些常见问题的，下面就来说说fetch使用的常见问题。</p><h2 id="fetch兼容性" style="margin-top: 20px; margin-bottom: 20px; font-size: 21px; line-height: 1.5; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">fetch兼容性</h2><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">fetch是相对较新的技术，当然就会存在浏览器兼容性的问题，借用上面应用文章的一幅图加以说明fetch在各种浏览器的原生支持情况：<br style="margin: 0px; padding: 0px;"><img src="C:\Users\Administrator\Documents\My Knowledge\temp\332f3963-a040-4bbf-92d6-3dc573412f6f\128\index_files\0.11165010003694964.png" style="margin-top: 0px; margin-bottom: 0px; padding: 0px; border-style: none; border-width: initial; max-width: 800px;"></p><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">从上图可以看出，在各个浏览器低版本的情况下都是不被支持的。</p><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">那么问题来了，如何在所有浏览器中通用fetch呢，当然就要考虑fetch的polyfill了。</p><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">上面说过，fetch是基于Promise来实现的，所以在低版本浏览器中Promise可能也未被原生支持，所以还需要Promise的polyfill；<strong style="margin: 0px; padding: 0px;">大多数情况下</strong>，实现fetch的polyfill需要涉及到的：</p><ul style="margin-bottom: 1em; margin-left: 40px; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><li style="padding: 0px; list-style-type: disc;"><strong style="margin: 0px; padding: 0px;">promise的polyfill</strong>，例如es6-promise、babel-polyfill提供的promise实现。</li><li style="padding: 0px; list-style-type: disc;"><strong style="margin: 0px; padding: 0px;">fetch的polyfill实现</strong>，例如isomorphic-fetch和whatwg-fetch</li></ul><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">这样是否就可以安全的使用fetch来进行前后端通信了？上面说了在大多数情况下是这样，但是IE8/9则比较特殊：IE8它使用的是ES3，而IE9则对ES5部分支持。这种情况下还需要<strong style="margin: 0px; padding: 0px;">ES5的polyfill</strong>&nbsp;<a href="https://github.com/es-shims/es5-shim" style="margin: 0px; padding: 0px; color: rgb(0, 0, 0);"><code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">es5-shim</code></a>支持了。</p><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">上述有关promise的polyfill实现，需要说明的是：</p><blockquote style="margin-top: 0px; margin-bottom: 0px; padding: 5px 10px; border-style: none none none solid; border-left-width: 5px; border-left-color: rgb(221, 221, 221); border-image-source: initial; border-image-slice: initial; border-image-width: initial; border-image-outset: initial; border-image-repeat: initial; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background: none rgb(255, 255, 255);"><p style="padding: 0px; color: rgb(119, 119, 119);">babel-runtime是不能作为Promise的polyfill的实现的，否则在IE8/9下使用fetch会报<code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">Promise未定义</code>。为什么？我想大家猜到了，因为babel-runtime实现的polyfill是局部实现而不是全局实现，fetch底层实现用到Promise就是从全局中去取的，拿不到这报上述错误。</p></blockquote><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">另外，顺便补充一下fetch的polyfill实现思路是：</p><blockquote style="margin-top: 0px; margin-bottom: 0px; padding: 5px 10px; border-style: none none none solid; border-left-width: 5px; border-left-color: rgb(221, 221, 221); border-image-source: initial; border-image-slice: initial; border-image-width: initial; border-image-outset: initial; border-image-repeat: initial; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background: none rgb(255, 255, 255);"><p style="padding: 0px; color: rgb(119, 119, 119);">首先判断浏览器是否原生支持fetch，否则结合Promise使用XMLHttpRequest的方式来实现；这正是<a href="https://github.com/github/fetch" style="margin: 0px; padding: 0px; color: rgb(0, 0, 0);"><code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">whatwg-fetch</code></a>的实现思路，而同构应用中使用的<a href="https://github.com/matthew-andrews/isomorphic-fetch" style="margin: 0px; padding: 0px; color: rgb(0, 0, 0);"><code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">isomorphic-fetch</code></a>，其客户端fetch的实现是直接require whatwg-fetch来实现的。</p></blockquote><h2 id="fetch默认不携带cookie" style="margin-top: 20px; margin-bottom: 20px; font-size: 21px; line-height: 1.5; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">fetch默认不携带cookie</h2><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">fetch发送请求默认是不发送cookie的，不管是同域还是跨域；那么问题就来了，对于那些需要权限验证的请求就可能无法正常获取数据，这时可以配置其<code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">credentials</code>项，其有3个值：</p><ul style="margin-bottom: 1em; margin-left: 40px; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><li style="padding: 0px; list-style-type: disc;"><code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">omit</code>: 默认值，忽略cookie的发送</li><li style="padding: 0px; list-style-type: disc;"><code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">same-origin</code>: 表示cookie只能同域发送，不能跨域发送</li><li style="padding: 0px; list-style-type: disc;"><code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">include</code>: cookie既可以同域发送，也可以跨域发送</li></ul><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">credentials</code>所表达的含义，其实与XHR2中的<code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">withCredentials</code>属性类似，表示请求是否携带cookie；具体可以参考阮一峰老师的<a href="http://www.ruanyifeng.com/blog/2016/04/cors.html" style="margin: 0px; padding: 0px; color: rgb(0, 0, 0);">跨域资源共享 CORS 详解</a>中withCredentials一节的介绍；</p><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">这样，若要fetch请求携带cookie信息，只需设置一下credentials选项即可，例如<code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">fetch(url, {credentials: 'include'})</code>;</p><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">另外补充一点：</p><blockquote style="margin-top: 0px; margin-bottom: 0px; padding: 5px 10px; border-style: none none none solid; border-left-width: 5px; border-left-color: rgb(221, 221, 221); border-image-source: initial; border-image-slice: initial; border-image-width: initial; border-image-outset: initial; border-image-repeat: initial; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background: none rgb(255, 255, 255);"><p style="padding: 0px; color: rgb(119, 119, 119);">fetch默认对服务端通过<code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">Set-Cookie</code>头设置的cookie也会忽略，若想选择接受来自服务端的cookie信息，也必须要配置credentials选项；</p></blockquote><h2 id="fetch请求对某些错误http状态不会reject" style="margin-top: 20px; margin-bottom: 20px; font-size: 21px; line-height: 1.5; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">fetch请求对某些错误http状态不会reject</h2><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">这主要是由fetch返回promise导致的，因为fetch返回的promise在某些错误的http状态下如400、500等不会reject，相反它会被resolve；只有网络错误会导致请求不能完成时，fetch 才会被 reject；所以一般会对fetch请求做一层封装，例如下面代码所示：</p><div class="sourceCode" style="padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><pre class="sourceCode javascript" style="margin-top: 10px; margin-bottom: 10px; padding: 0px; white-space: pre-wrap; word-wrap: break-word;"><code class="sourceCode javascript hljs" style="margin: auto; vertical-align: middle; display: block; height: auto; overflow-x: auto; color: rgb(0, 0, 0); padding: 5px !important; line-height: 1.5 !important; font-family: 'Courier New', sans-serif !important; font-size: 12px !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-function" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">function</span></span></span><span class="hljs-function" style="margin: 0px; padding: 0px;"> </span><span class="at" style="margin: 0px; padding: 0px;"><span class="hljs-function" style="margin: 0px; padding: 0px;"><span class="hljs-title" style="margin: 0px; padding: 0px; color: rgb(163, 21, 21);">checkStatus</span></span></span><span class="hljs-function" style="margin: 0px; padding: 0px;">(<span class="hljs-params" style="margin: 0px; padding: 0px;">response</span>) </span><span class="op" style="margin: 0px; padding: 0px;">{</span>
  <span class="cf" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">if</span></span> (<span class="va" style="margin: 0px; padding: 0px;">response</span>.<span class="at" style="margin: 0px; padding: 0px;">status</span> <span class="op" style="margin: 0px; padding: 0px;">&gt;=</span> <span class="dv" style="margin: 0px; padding: 0px;">200</span> <span class="op" style="margin: 0px; padding: 0px;">&amp;&amp;</span> <span class="va" style="margin: 0px; padding: 0px;">response</span>.<span class="at" style="margin: 0px; padding: 0px;">status</span> <span class="op" style="margin: 0px; padding: 0px;">&lt;</span> <span class="dv" style="margin: 0px; padding: 0px;">300</span>) <span class="op" style="margin: 0px; padding: 0px;">{</span>
    <span class="cf" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">return</span></span> response<span class="op" style="margin: 0px; padding: 0px;">;</span>
  <span class="op" style="margin: 0px; padding: 0px;">}</span>
  <span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">const</span></span> error <span class="op" style="margin: 0px; padding: 0px;">=</span> <span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">new</span></span> <span class="at" style="margin: 0px; padding: 0px;"><span class="hljs-built_in" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">Error</span></span>(<span class="va" style="margin: 0px; padding: 0px;">response</span>.<span class="at" style="margin: 0px; padding: 0px;">statusText</span>)<span class="op" style="margin: 0px; padding: 0px;">;</span>
  <span class="va" style="margin: 0px; padding: 0px;">error</span>.<span class="at" style="margin: 0px; padding: 0px;">response</span> <span class="op" style="margin: 0px; padding: 0px;">=</span> response<span class="op" style="margin: 0px; padding: 0px;">;</span>
  <span class="cf" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">throw</span></span> error<span class="op" style="margin: 0px; padding: 0px;">;</span>
<span class="op" style="margin: 0px; padding: 0px;">}</span>
<span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-function" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">function</span></span></span><span class="hljs-function" style="margin: 0px; padding: 0px;"> </span><span class="at" style="margin: 0px; padding: 0px;"><span class="hljs-function" style="margin: 0px; padding: 0px;"><span class="hljs-title" style="margin: 0px; padding: 0px; color: rgb(163, 21, 21);">parseJSON</span></span></span><span class="hljs-function" style="margin: 0px; padding: 0px;">(<span class="hljs-params" style="margin: 0px; padding: 0px;">response</span>) </span><span class="op" style="margin: 0px; padding: 0px;">{</span>
  <span class="cf" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">return</span></span> <span class="va" style="margin: 0px; padding: 0px;">response</span>.<span class="at" style="margin: 0px; padding: 0px;">json</span>()<span class="op" style="margin: 0px; padding: 0px;">;</span>
<span class="op" style="margin: 0px; padding: 0px;">}</span>
<span class="im" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">export</span></span> <span class="im" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">default</span></span> <span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-function" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">function</span></span></span><span class="hljs-function" style="margin: 0px; padding: 0px;"> </span><span class="at" style="margin: 0px; padding: 0px;"><span class="hljs-function" style="margin: 0px; padding: 0px;"><span class="hljs-title" style="margin: 0px; padding: 0px; color: rgb(163, 21, 21);">request</span></span></span><span class="hljs-function" style="margin: 0px; padding: 0px;">(<span class="hljs-params" style="margin: 0px; padding: 0px;">url</span></span><span class="op" style="margin: 0px; padding: 0px;">,</span><span class="hljs-function" style="margin: 0px; padding: 0px;"><span class="hljs-params" style="margin: 0px; padding: 0px;"> options</span>) </span><span class="op" style="margin: 0px; padding: 0px;">{</span>
  <span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">let</span></span> opt <span class="op" style="margin: 0px; padding: 0px;">=</span> options<span class="op" style="margin: 0px; padding: 0px;">||{};</span>
  <span class="cf" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">return</span></span> <span class="at" style="margin: 0px; padding: 0px;">fetch</span>(url<span class="op" style="margin: 0px; padding: 0px;">,</span> <span class="op" style="margin: 0px; padding: 0px;">{</span><span class="dt" style="margin: 0px; padding: 0px;">credentials</span><span class="op" style="margin: 0px; padding: 0px;">:</span> <span class="st" style="margin: 0px; padding: 0px;"><span class="hljs-string" style="margin: 0px; padding: 0px; color: rgb(163, 21, 21);">'include'</span></span><span class="op" style="margin: 0px; padding: 0px;">,</span> ...<span class="at" style="margin: 0px; padding: 0px;">opt</span><span class="op" style="margin: 0px; padding: 0px;">}</span>)
    .<span class="at" style="margin: 0px; padding: 0px;">then</span>(checkStatus)
    .<span class="at" style="margin: 0px; padding: 0px;">then</span>(parseJSON)
    .<span class="at" style="margin: 0px; padding: 0px;">then</span>((data) <span class="op" style="margin: 0px; padding: 0px;">=&gt;</span> ( data ))
    .<span class="at" style="margin: 0px; padding: 0px;">catch</span>((err) <span class="op" style="margin: 0px; padding: 0px;">=&gt;</span> ( err ))<span class="op" style="margin: 0px; padding: 0px;">;</span>
<span class="op" style="margin: 0px; padding: 0px;">}</span></code></pre></div><h2 id="fetch不支持超时timeout处理" style="margin-top: 20px; margin-bottom: 20px; font-size: 21px; line-height: 1.5; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">fetch不支持超时timeout处理</h2><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">用过fetch的都知道，fetch不像大多数ajax库那样对请求设置超时timeout，它没有有关请求超时的feature，这一点比较蛋疼。所以在fetch标准添加超时feature之前，都需要polyfill该特性。</p><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">实际上，我们真正需要的是<code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">abort()</code>， timeout可以通过<code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">timeout+abort</code>方式来实现，起到真正超时丢弃当前的请求。</p><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">而在目前的fetch指导规范中，fetch并不是一个具体实例，而只是一个方法；其返回的promise实例根据Promise指导规范标准是不能abort的，也不能手动改变promise实例的状态，只能由内部来根据请求结果来改变promise的状态。</p><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><strong style="margin: 0px; padding: 0px;">既然不能手动控制fetch方法执行后返回的promise实例状态，那么是不是可以创建一个可以手动控制状态的新Promise实例呢</strong>。所以：</p><pre style="margin-top: 10px; margin-bottom: 10px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; color: rgb(51, 51, 51); font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><code class="hljs" style="margin: auto; vertical-align: middle; display: block; height: auto; overflow-x: auto; color: rgb(0, 0, 0); padding: 5px !important; line-height: 1.5 !important; font-family: 'Courier New', sans-serif !important; font-size: 12px !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;">实现fetch的timeout功能，其思想就是新创建一个可以手动控制promise状态的实例，根据不同情况来对新promise实例进行resolve或者reject，从而达到实现timeout的功能；</code></pre><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">根据github上<a href="https://github.com/github/fetch/issues/175" style="margin: 0px; padding: 0px; color: rgb(0, 0, 0);">timeout handling</a>上的讨论，目前可以有两种不同的解决方法：</p><h4 id="方法一单纯settimeout方式" style="margin-top: 10px; margin-bottom: 10px; font-size: 14px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">方法一：单纯setTimeout方式</h4><div class="sourceCode" style="padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><pre class="sourceCode javascript" style="margin-top: 10px; margin-bottom: 10px; padding: 0px; white-space: pre-wrap; word-wrap: break-word;"><code class="sourceCode javascript hljs" style="margin: auto; vertical-align: middle; display: block; height: auto; overflow-x: auto; color: rgb(0, 0, 0); padding: 5px !important; line-height: 1.5 !important; font-family: 'Courier New', sans-serif !important; font-size: 12px !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">var</span></span> oldFetchfn <span class="op" style="margin: 0px; padding: 0px;">=</span> fetch<span class="op" style="margin: 0px; padding: 0px;">;</span> <span class="co" style="margin: 0px; padding: 0px;"><span class="hljs-comment" style="margin: 0px; padding: 0px; color: green;">//拦截原始的fetch方法</span></span>
<span class="va" style="margin: 0px; padding: 0px;"><span class="hljs-built_in" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">window</span></span>.<span class="at" style="margin: 0px; padding: 0px;">fetch</span> <span class="op" style="margin: 0px; padding: 0px;">=</span> <span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-function" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">function</span></span></span><span class="hljs-function" style="margin: 0px; padding: 0px;">(<span class="hljs-params" style="margin: 0px; padding: 0px;">input</span></span><span class="op" style="margin: 0px; padding: 0px;">,</span><span class="hljs-function" style="margin: 0px; padding: 0px;"><span class="hljs-params" style="margin: 0px; padding: 0px;"> opts</span>)</span><span class="op" style="margin: 0px; padding: 0px;">{</span><span class="co" style="margin: 0px; padding: 0px;"><span class="hljs-comment" style="margin: 0px; padding: 0px; color: green;">//定义新的fetch方法，封装原有的fetch方法</span></span>
    <span class="cf" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">return</span></span> <span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">new</span></span> <span class="at" style="margin: 0px; padding: 0px;"><span class="hljs-built_in" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">Promise</span></span>(<span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-function" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">function</span></span></span><span class="hljs-function" style="margin: 0px; padding: 0px;">(<span class="hljs-params" style="margin: 0px; padding: 0px;">resolve</span></span><span class="op" style="margin: 0px; padding: 0px;">,</span><span class="hljs-function" style="margin: 0px; padding: 0px;"><span class="hljs-params" style="margin: 0px; padding: 0px;"> reject</span>)</span><span class="op" style="margin: 0px; padding: 0px;">{</span>
        <span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">var</span></span> timeoutId <span class="op" style="margin: 0px; padding: 0px;">=</span> <span class="at" style="margin: 0px; padding: 0px;">setTimeout</span>(<span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-function" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">function</span></span></span><span class="hljs-function" style="margin: 0px; padding: 0px;">(<span class="hljs-params" style="margin: 0px; padding: 0px;"></span>)</span><span class="op" style="margin: 0px; padding: 0px;">{</span>
            <span class="at" style="margin: 0px; padding: 0px;">reject</span>(<span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">new</span></span> <span class="at" style="margin: 0px; padding: 0px;"><span class="hljs-built_in" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">Error</span></span>(<span class="st" style="margin: 0px; padding: 0px;"><span class="hljs-string" style="margin: 0px; padding: 0px; color: rgb(163, 21, 21);">"fetch timeout"</span></span>))
        <span class="op" style="margin: 0px; padding: 0px;">},</span> <span class="va" style="margin: 0px; padding: 0px;">opts</span>.<span class="at" style="margin: 0px; padding: 0px;">timeout</span>)<span class="op" style="margin: 0px; padding: 0px;">;</span>
        <span class="at" style="margin: 0px; padding: 0px;">oldFetchfn</span>(input<span class="op" style="margin: 0px; padding: 0px;">,</span> opts).<span class="at" style="margin: 0px; padding: 0px;">then</span>(
            res<span class="op" style="margin: 0px; padding: 0px;">=&gt;{</span>
                <span class="at" style="margin: 0px; padding: 0px;">clearTimeout</span>(timeoutId)<span class="op" style="margin: 0px; padding: 0px;">;</span>
                <span class="at" style="margin: 0px; padding: 0px;">resolve</span>(res)
            <span class="op" style="margin: 0px; padding: 0px;">},</span>
            err<span class="op" style="margin: 0px; padding: 0px;">=&gt;{</span>
                <span class="at" style="margin: 0px; padding: 0px;">clearTimeout</span>(timeoutId)<span class="op" style="margin: 0px; padding: 0px;">;</span>
                <span class="at" style="margin: 0px; padding: 0px;">reject</span>(err)
            <span class="op" style="margin: 0px; padding: 0px;">}</span>
        )
    <span class="op" style="margin: 0px; padding: 0px;">}</span>)
<span class="op" style="margin: 0px; padding: 0px;">}</span></code></pre></div><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">当然在上面基础上可以模拟类似XHR的<code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">abort</code>功能：</p><div class="sourceCode" style="padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><pre class="sourceCode javascript" style="margin-top: 10px; margin-bottom: 10px; padding: 0px; white-space: pre-wrap; word-wrap: break-word;"><code class="sourceCode javascript hljs" style="margin: auto; vertical-align: middle; display: block; height: auto; overflow-x: auto; color: rgb(0, 0, 0); padding: 5px !important; line-height: 1.5 !important; font-family: 'Courier New', sans-serif !important; font-size: 12px !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">var</span></span> oldFetchfn <span class="op" style="margin: 0px; padding: 0px;">=</span> fetch<span class="op" style="margin: 0px; padding: 0px;">;</span> 
<span class="va" style="margin: 0px; padding: 0px;"><span class="hljs-built_in" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">window</span></span>.<span class="at" style="margin: 0px; padding: 0px;">fetch</span> <span class="op" style="margin: 0px; padding: 0px;">=</span> <span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-function" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">function</span></span></span><span class="hljs-function" style="margin: 0px; padding: 0px;">(<span class="hljs-params" style="margin: 0px; padding: 0px;">input</span></span><span class="op" style="margin: 0px; padding: 0px;">,</span><span class="hljs-function" style="margin: 0px; padding: 0px;"><span class="hljs-params" style="margin: 0px; padding: 0px;"> opts</span>)</span><span class="op" style="margin: 0px; padding: 0px;">{</span>
    <span class="cf" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">return</span></span> <span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">new</span></span> <span class="at" style="margin: 0px; padding: 0px;"><span class="hljs-built_in" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">Promise</span></span>(<span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-function" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">function</span></span></span><span class="hljs-function" style="margin: 0px; padding: 0px;">(<span class="hljs-params" style="margin: 0px; padding: 0px;">resolve</span></span><span class="op" style="margin: 0px; padding: 0px;">,</span><span class="hljs-function" style="margin: 0px; padding: 0px;"><span class="hljs-params" style="margin: 0px; padding: 0px;"> reject</span>)</span><span class="op" style="margin: 0px; padding: 0px;">{</span>
        <span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">var</span></span> abort_promise <span class="op" style="margin: 0px; padding: 0px;">=</span> <span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-function" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">function</span></span></span><span class="hljs-function" style="margin: 0px; padding: 0px;">(<span class="hljs-params" style="margin: 0px; padding: 0px;"></span>)</span><span class="op" style="margin: 0px; padding: 0px;">{</span>
            <span class="at" style="margin: 0px; padding: 0px;">reject</span>(<span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">new</span></span> <span class="at" style="margin: 0px; padding: 0px;"><span class="hljs-built_in" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">Error</span></span>(<span class="st" style="margin: 0px; padding: 0px;"><span class="hljs-string" style="margin: 0px; padding: 0px; color: rgb(163, 21, 21);">"fetch abort"</span></span>))
        <span class="op" style="margin: 0px; padding: 0px;">};</span>
        <span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">var</span></span> p <span class="op" style="margin: 0px; padding: 0px;">=</span> <span class="at" style="margin: 0px; padding: 0px;">oldFetchfn</span>(input<span class="op" style="margin: 0px; padding: 0px;">,</span> opts).<span class="at" style="margin: 0px; padding: 0px;">then</span>(resolve<span class="op" style="margin: 0px; padding: 0px;">,</span> reject)<span class="op" style="margin: 0px; padding: 0px;">;</span>
        <span class="va" style="margin: 0px; padding: 0px;">p</span>.<span class="at" style="margin: 0px; padding: 0px;">abort</span> <span class="op" style="margin: 0px; padding: 0px;">=</span> abort_promise<span class="op" style="margin: 0px; padding: 0px;">;</span>
        <span class="cf" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">return</span></span> p<span class="op" style="margin: 0px; padding: 0px;">;</span>
    <span class="op" style="margin: 0px; padding: 0px;">}</span>)
<span class="op" style="margin: 0px; padding: 0px;">}</span></code></pre></div><h4 id="方法二利用promise.race方法" style="margin-top: 10px; margin-bottom: 10px; font-size: 14px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">方法二：利用Promise.race方法</h4><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">Promise.race方法接受一个promise实例数组参数，表示多个promise实例中任何一个最先改变状态，那么race方法返回的promise实例状态就跟着改变，具体可以参考<a href="http://es6.ruanyifeng.com/#docs/promise#Promise-race" style="margin: 0px; padding: 0px; color: rgb(0, 0, 0);">这里</a>。</p><div class="sourceCode" style="padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><pre class="sourceCode javascript" style="margin-top: 10px; margin-bottom: 10px; padding: 0px; white-space: pre-wrap; word-wrap: break-word;"><code class="sourceCode javascript hljs" style="margin: auto; vertical-align: middle; display: block; height: auto; overflow-x: auto; color: rgb(0, 0, 0); padding: 5px !important; line-height: 1.5 !important; font-family: 'Courier New', sans-serif !important; font-size: 12px !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">var</span></span> oldFetchfn <span class="op" style="margin: 0px; padding: 0px;">=</span> fetch<span class="op" style="margin: 0px; padding: 0px;">;</span> <span class="co" style="margin: 0px; padding: 0px;"><span class="hljs-comment" style="margin: 0px; padding: 0px; color: green;">//拦截原始的fetch方法</span></span>
<span class="va" style="margin: 0px; padding: 0px;"><span class="hljs-built_in" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">window</span></span>.<span class="at" style="margin: 0px; padding: 0px;">fetch</span> <span class="op" style="margin: 0px; padding: 0px;">=</span> <span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-function" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">function</span></span></span><span class="hljs-function" style="margin: 0px; padding: 0px;">(<span class="hljs-params" style="margin: 0px; padding: 0px;">input</span></span><span class="op" style="margin: 0px; padding: 0px;">,</span><span class="hljs-function" style="margin: 0px; padding: 0px;"><span class="hljs-params" style="margin: 0px; padding: 0px;"> opts</span>)</span><span class="op" style="margin: 0px; padding: 0px;">{</span><span class="co" style="margin: 0px; padding: 0px;"><span class="hljs-comment" style="margin: 0px; padding: 0px; color: green;">//定义新的fetch方法，封装原有的fetch方法</span></span>
    <span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">var</span></span> fetchPromise <span class="op" style="margin: 0px; padding: 0px;">=</span> <span class="at" style="margin: 0px; padding: 0px;">oldFetchfn</span>(input<span class="op" style="margin: 0px; padding: 0px;">,</span> opts)<span class="op" style="margin: 0px; padding: 0px;">;</span>
    <span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">var</span></span> timeoutPromise <span class="op" style="margin: 0px; padding: 0px;">=</span> <span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">new</span></span> <span class="at" style="margin: 0px; padding: 0px;"><span class="hljs-built_in" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">Promise</span></span>(<span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-function" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">function</span></span></span><span class="hljs-function" style="margin: 0px; padding: 0px;">(<span class="hljs-params" style="margin: 0px; padding: 0px;">resolve</span></span><span class="op" style="margin: 0px; padding: 0px;">,</span><span class="hljs-function" style="margin: 0px; padding: 0px;"><span class="hljs-params" style="margin: 0px; padding: 0px;"> reject</span>)</span><span class="op" style="margin: 0px; padding: 0px;">{</span>
        <span class="at" style="margin: 0px; padding: 0px;">setTimeout</span>(()<span class="op" style="margin: 0px; padding: 0px;">=&gt;{</span>
             <span class="at" style="margin: 0px; padding: 0px;">reject</span>(<span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">new</span></span> <span class="at" style="margin: 0px; padding: 0px;"><span class="hljs-built_in" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">Error</span></span>(<span class="st" style="margin: 0px; padding: 0px;"><span class="hljs-string" style="margin: 0px; padding: 0px; color: rgb(163, 21, 21);">"fetch timeout"</span></span>))
        <span class="op" style="margin: 0px; padding: 0px;">},</span> <span class="va" style="margin: 0px; padding: 0px;">opts</span>.<span class="at" style="margin: 0px; padding: 0px;">timeout</span>)
    <span class="op" style="margin: 0px; padding: 0px;">}</span>)<span class="op" style="margin: 0px; padding: 0px;">;</span>
    retrun <span class="va" style="margin: 0px; padding: 0px;"><span class="hljs-built_in" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">Promise</span></span>.<span class="at" style="margin: 0px; padding: 0px;">race</span>([fetchPromise<span class="op" style="margin: 0px; padding: 0px;">,</span> timeoutPromise])
<span class="op" style="margin: 0px; padding: 0px;">}</span></code></pre></div><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">最后，对fetch的timeout的上述实现方式补充几点：</p><blockquote style="margin-top: 0px; margin-bottom: 0px; padding: 5px 10px; border-style: none none none solid; border-left-width: 5px; border-left-color: rgb(221, 221, 221); border-image-source: initial; border-image-slice: initial; border-image-width: initial; border-image-outset: initial; border-image-repeat: initial; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background: none rgb(255, 255, 255);"><p style="padding: 0px; color: rgb(119, 119, 119);">timeout不是请求连接超时的含义，它表示请求的response时间，包括请求的连接、服务器处理及服务器响应回来的时间；</p></blockquote><blockquote style="margin-top: 0px; margin-bottom: 0px; padding: 5px 10px; border-style: none none none solid; border-left-width: 5px; border-left-color: rgb(221, 221, 221); border-image-source: initial; border-image-slice: initial; border-image-width: initial; border-image-outset: initial; border-image-repeat: initial; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background: none rgb(255, 255, 255);"><p style="padding: 0px; color: rgb(119, 119, 119);">fetch的timeout即使超时发生了，本次请求也不会被abort丢弃掉，它在后台仍然会发送到服务器端，只是本次请求的响应内容被丢弃而已；</p></blockquote><h2 id="fetch不支持jsonp" style="margin-top: 20px; margin-bottom: 20px; font-size: 21px; line-height: 1.5; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">fetch不支持JSONP</h2><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">fetch是与服务器端进行异步交互的，而<strong style="margin: 0px; padding: 0px;">JSONP是外链一个javascript资源，并不是真正ajax</strong>，所以fetch与JSONP没有什么直接关联，当然至少目前是不支持JSONP的。</p><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">这里我们把JSONP与fetch关联在一起有点差强人意，fetch只是一个ajax库，我们不可能使fetch支持JSONP；只是我们要实现一个JSONP，只不过这个JSONP的实现要与fetch的实现类似，<code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">即基于Promise来实现一个JSONP</code>；而其外在表现给人感觉是fetch支持JSONP一样；</p><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">目前比较成熟的开源JSONP实现<a href="https://github.com/camsong/fetch-jsonp" style="margin: 0px; padding: 0px; color: rgb(0, 0, 0);">fetch-jsonp</a>给我们提供了解决方案，想了解可以自行前往。不过再次想唠叨一下其JSONP的实现步骤，因为在本人面试的前端候选人中大部分人对JSONP的实现语焉不详；</p><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">使用它非常简单，首先需要用npm安装fetch-jsonp</p><div class="sourceCode" style="padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><pre class="sourceCode javascript" style="margin-top: 10px; margin-bottom: 10px; padding: 0px; white-space: pre-wrap; word-wrap: break-word;"><code class="sourceCode javascript hljs" style="margin: auto; vertical-align: middle; display: block; height: auto; overflow-x: auto; color: rgb(0, 0, 0); padding: 5px !important; line-height: 1.5 !important; font-family: 'Courier New', sans-serif !important; font-size: 12px !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"> npm install fetch<span class="op" style="margin: 0px; padding: 0px;">-</span>jsonp <span class="op" style="margin: 0px; padding: 0px;">--</span>save<span class="op" style="margin: 0px; padding: 0px;">-</span>dev</code></pre></div><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">然后在像下面一样使用：</p><div class="sourceCode" style="padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><pre class="sourceCode javascript" style="margin-top: 10px; margin-bottom: 10px; padding: 0px; white-space: pre-wrap; word-wrap: break-word;"><code class="sourceCode javascript hljs" style="margin: auto; vertical-align: middle; display: block; height: auto; overflow-x: auto; color: rgb(0, 0, 0); padding: 5px !important; line-height: 1.5 !important; font-family: 'Courier New', sans-serif !important; font-size: 12px !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><span class="at" style="margin: 0px; padding: 0px;">fetchJsonp</span>(<span class="st" style="margin: 0px; padding: 0px;"><span class="hljs-string" style="margin: 0px; padding: 0px; color: rgb(163, 21, 21);">'/users.jsonp'</span></span><span class="op" style="margin: 0px; padding: 0px;">,</span> <span class="op" style="margin: 0px; padding: 0px;">{</span>
    <span class="dt" style="margin: 0px; padding: 0px;">timeout</span><span class="op" style="margin: 0px; padding: 0px;">:</span> <span class="dv" style="margin: 0px; padding: 0px;">3000</span><span class="op" style="margin: 0px; padding: 0px;">,</span>
    <span class="dt" style="margin: 0px; padding: 0px;">jsonpCallback</span><span class="op" style="margin: 0px; padding: 0px;">:</span> <span class="st" style="margin: 0px; padding: 0px;"><span class="hljs-string" style="margin: 0px; padding: 0px; color: rgb(163, 21, 21);">'custom_callback'</span></span>
  <span class="op" style="margin: 0px; padding: 0px;">}</span>)
  .<span class="at" style="margin: 0px; padding: 0px;">then</span>(<span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-function" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">function</span></span></span><span class="hljs-function" style="margin: 0px; padding: 0px;">(<span class="hljs-params" style="margin: 0px; padding: 0px;">response</span>) </span><span class="op" style="margin: 0px; padding: 0px;">{</span>
    <span class="cf" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">return</span></span> <span class="va" style="margin: 0px; padding: 0px;">response</span>.<span class="at" style="margin: 0px; padding: 0px;">json</span>()
  <span class="op" style="margin: 0px; padding: 0px;">}</span>).<span class="at" style="margin: 0px; padding: 0px;">catch</span>(<span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-function" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">function</span></span></span><span class="hljs-function" style="margin: 0px; padding: 0px;">(<span class="hljs-params" style="margin: 0px; padding: 0px;">ex</span>) </span><span class="op" style="margin: 0px; padding: 0px;">{</span>
    <span class="va" style="margin: 0px; padding: 0px;"><span class="hljs-built_in" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">console</span></span>.<span class="at" style="margin: 0px; padding: 0px;">log</span>(<span class="st" style="margin: 0px; padding: 0px;"><span class="hljs-string" style="margin: 0px; padding: 0px; color: rgb(163, 21, 21);">'parsing failed'</span></span><span class="op" style="margin: 0px; padding: 0px;">,</span> ex)
  <span class="op" style="margin: 0px; padding: 0px;">}</span>)</code></pre></div><h2 id="fetch不支持progress事件" style="margin-top: 20px; margin-bottom: 20px; font-size: 21px; line-height: 1.5; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">fetch不支持progress事件</h2><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">XHR是原生支持progress事件的，例如下面代码这样：</p><div class="sourceCode" style="padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><pre class="sourceCode javascript" style="margin-top: 10px; margin-bottom: 10px; padding: 0px; white-space: pre-wrap; word-wrap: break-word;"><code class="sourceCode javascript hljs" style="margin: auto; vertical-align: middle; display: block; height: auto; overflow-x: auto; color: rgb(0, 0, 0); padding: 5px !important; line-height: 1.5 !important; font-family: 'Courier New', sans-serif !important; font-size: 12px !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">var</span></span> xhr <span class="op" style="margin: 0px; padding: 0px;">=</span> <span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">new</span></span> <span class="at" style="margin: 0px; padding: 0px;">XMLHttpRequest</span>()
<span class="va" style="margin: 0px; padding: 0px;">xhr</span>.<span class="at" style="margin: 0px; padding: 0px;">open</span>(<span class="st" style="margin: 0px; padding: 0px;"><span class="hljs-string" style="margin: 0px; padding: 0px; color: rgb(163, 21, 21);">'POST'</span></span><span class="op" style="margin: 0px; padding: 0px;">,</span> <span class="st" style="margin: 0px; padding: 0px;"><span class="hljs-string" style="margin: 0px; padding: 0px; color: rgb(163, 21, 21);">'/uploads'</span></span>)
<span class="va" style="margin: 0px; padding: 0px;">xhr</span>.<span class="at" style="margin: 0px; padding: 0px;">onload</span> <span class="op" style="margin: 0px; padding: 0px;">=</span> <span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-function" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">function</span></span></span><span class="hljs-function" style="margin: 0px; padding: 0px;">(<span class="hljs-params" style="margin: 0px; padding: 0px;"></span>) </span><span class="op" style="margin: 0px; padding: 0px;">{}</span>
<span class="va" style="margin: 0px; padding: 0px;">xhr</span>.<span class="at" style="margin: 0px; padding: 0px;">onerror</span> <span class="op" style="margin: 0px; padding: 0px;">=</span> <span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-function" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">function</span></span></span><span class="hljs-function" style="margin: 0px; padding: 0px;">(<span class="hljs-params" style="margin: 0px; padding: 0px;"></span>) </span><span class="op" style="margin: 0px; padding: 0px;">{}</span>
<span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-function" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">function</span></span></span><span class="hljs-function" style="margin: 0px; padding: 0px;"> </span><span class="at" style="margin: 0px; padding: 0px;"><span class="hljs-function" style="margin: 0px; padding: 0px;"><span class="hljs-title" style="margin: 0px; padding: 0px; color: rgb(163, 21, 21);">updateProgress</span></span></span><span class="hljs-function" style="margin: 0px; padding: 0px;"> (<span class="hljs-params" style="margin: 0px; padding: 0px;">event</span>) </span><span class="op" style="margin: 0px; padding: 0px;">{</span>
  <span class="cf" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">if</span></span> (<span class="va" style="margin: 0px; padding: 0px;">event</span>.<span class="at" style="margin: 0px; padding: 0px;">lengthComputable</span>) <span class="op" style="margin: 0px; padding: 0px;">{</span>
    <span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">var</span></span> percent <span class="op" style="margin: 0px; padding: 0px;">=</span> <span class="va" style="margin: 0px; padding: 0px;"><span class="hljs-built_in" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">Math</span></span>.<span class="at" style="margin: 0px; padding: 0px;">round</span>((<span class="va" style="margin: 0px; padding: 0px;">event</span>.<span class="at" style="margin: 0px; padding: 0px;">loaded</span> / <span class="va" style="margin: 0px; padding: 0px;">event</span>.<span class="at" style="margin: 0px; padding: 0px;">total</span>) <span class="op" style="margin: 0px; padding: 0px;">*</span> <span class="dv" style="margin: 0px; padding: 0px;">100</span>)
    <span class="va" style="margin: 0px; padding: 0px;"><span class="hljs-built_in" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">console</span></span>.<span class="at" style="margin: 0px; padding: 0px;">log</span>(percent)
  <span class="op" style="margin: 0px; padding: 0px;">}</span>
<span class="va" style="margin: 0px; padding: 0px;">xhr</span>.<span class="va" style="margin: 0px; padding: 0px;">upload</span>.<span class="at" style="margin: 0px; padding: 0px;">onprogress</span> <span class="op" style="margin: 0px; padding: 0px;">=</span>updateProgress<span class="op" style="margin: 0px; padding: 0px;">;</span> <span class="co" style="margin: 0px; padding: 0px;"><span class="hljs-comment" style="margin: 0px; padding: 0px; color: green;">//上传的progress事件</span></span>
<span class="va" style="margin: 0px; padding: 0px;">xhr</span>.<span class="at" style="margin: 0px; padding: 0px;">onprogress</span> <span class="op" style="margin: 0px; padding: 0px;">=</span> updateProgress<span class="op" style="margin: 0px; padding: 0px;">;</span> <span class="co" style="margin: 0px; padding: 0px;"><span class="hljs-comment" style="margin: 0px; padding: 0px; color: green;">//下载的progress事件</span></span>
<span class="op" style="margin: 0px; padding: 0px;">}</span>
<span class="va" style="margin: 0px; padding: 0px;">xhr</span>.<span class="at" style="margin: 0px; padding: 0px;">send</span>()<span class="op" style="margin: 0px; padding: 0px;">;</span></code></pre></div><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">但是<strong style="margin: 0px; padding: 0px;">fetch是不支持有关<code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">progress</code>事件的</strong>；不过可喜的是，根据fetch的指导规范标准，其内部设计实现了<code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">Request</code>和<code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">Response</code>类；其中Response封装一些方法和属性，通过Response实例可以访问这些方法和属性，例如<code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">response.json()</code>、<code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">response.body</code>等等；</p><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">值得关注的地方是，<code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">response.body</code>是一个可读字节流对象，其实现了一个<code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">getRender()</code>方法，其具体作用是：</p><blockquote style="margin-top: 0px; margin-bottom: 0px; padding: 5px 10px; border-style: none none none solid; border-left-width: 5px; border-left-color: rgb(221, 221, 221); border-image-source: initial; border-image-slice: initial; border-image-width: initial; border-image-outset: initial; border-image-repeat: initial; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background: none rgb(255, 255, 255);"><p style="padding: 0px; color: rgb(119, 119, 119);"><code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">getRender()</code>方法用于读取响应的原始字节流，该字节流是可以循环读取的，直至body内容传输完成；</p></blockquote><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">因此，利用到这点可以模拟出fetch的progress，具体可以参考这篇文章<a href="https://jakearchibald.com/2016/streams-ftw/" style="margin: 0px; padding: 0px; color: rgb(0, 0, 0);">2016 - the year of web streams</a>。</p><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">代码实现如下，在线demo请参考<a href="https://labs.jxck.io/fetch/progress.html" style="margin: 0px; padding: 0px; color: rgb(0, 0, 0);">fetch progress demo</a>。</p><div class="sourceCode" style="padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><pre class="sourceCode javascript" style="margin-top: 10px; margin-bottom: 10px; padding: 0px; white-space: pre-wrap; word-wrap: break-word;"><code class="sourceCode javascript hljs" style="margin: auto; vertical-align: middle; display: block; height: auto; overflow-x: auto; color: rgb(0, 0, 0); padding: 5px !important; line-height: 1.5 !important; font-family: 'Courier New', sans-serif !important; font-size: 12px !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><span class="co" style="margin: 0px; padding: 0px;"><span class="hljs-comment" style="margin: 0px; padding: 0px; color: green;">// fetch() returns a promise that resolves once headers have been received</span></span>
<span class="at" style="margin: 0px; padding: 0px;">fetch</span>(url).<span class="at" style="margin: 0px; padding: 0px;">then</span>(response <span class="op" style="margin: 0px; padding: 0px;">=&gt;</span> <span class="op" style="margin: 0px; padding: 0px;">{</span>
  <span class="co" style="margin: 0px; padding: 0px;"><span class="hljs-comment" style="margin: 0px; padding: 0px; color: green;">// response.body is a readable stream.</span></span>
  <span class="co" style="margin: 0px; padding: 0px;"><span class="hljs-comment" style="margin: 0px; padding: 0px; color: green;">// Calling getReader() gives us exclusive access to the stream's content</span></span>
  <span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">var</span></span> reader <span class="op" style="margin: 0px; padding: 0px;">=</span> <span class="va" style="margin: 0px; padding: 0px;">response</span>.<span class="va" style="margin: 0px; padding: 0px;">body</span>.<span class="at" style="margin: 0px; padding: 0px;">getReader</span>()<span class="op" style="margin: 0px; padding: 0px;">;</span>
  <span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">var</span></span> bytesReceived <span class="op" style="margin: 0px; padding: 0px;">=</span> <span class="dv" style="margin: 0px; padding: 0px;">0</span><span class="op" style="margin: 0px; padding: 0px;">;</span>

  <span class="co" style="margin: 0px; padding: 0px;"><span class="hljs-comment" style="margin: 0px; padding: 0px; color: green;">// read() returns a promise that resolves when a value has been received</span></span>
  <span class="va" style="margin: 0px; padding: 0px;">reader</span>.<span class="at" style="margin: 0px; padding: 0px;">read</span>().<span class="at" style="margin: 0px; padding: 0px;">then</span>(<span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-function" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">function</span></span></span><span class="hljs-function" style="margin: 0px; padding: 0px;"> </span><span class="at" style="margin: 0px; padding: 0px;"><span class="hljs-function" style="margin: 0px; padding: 0px;"><span class="hljs-title" style="margin: 0px; padding: 0px; color: rgb(163, 21, 21);">processResult</span></span></span><span class="hljs-function" style="margin: 0px; padding: 0px;">(<span class="hljs-params" style="margin: 0px; padding: 0px;">result</span>) </span><span class="op" style="margin: 0px; padding: 0px;">{</span>
    <span class="co" style="margin: 0px; padding: 0px;"><span class="hljs-comment" style="margin: 0px; padding: 0px; color: green;">// Result objects contain two properties:</span></span>
    <span class="co" style="margin: 0px; padding: 0px;"><span class="hljs-comment" style="margin: 0px; padding: 0px; color: green;">// done  - true if the stream has already given you all its data.</span></span>
    <span class="co" style="margin: 0px; padding: 0px;"><span class="hljs-comment" style="margin: 0px; padding: 0px; color: green;">// value - some data. Always undefined when done is true.</span></span>
    <span class="cf" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">if</span></span> (<span class="va" style="margin: 0px; padding: 0px;">result</span>.<span class="at" style="margin: 0px; padding: 0px;">done</span>) <span class="op" style="margin: 0px; padding: 0px;">{</span>
      <span class="va" style="margin: 0px; padding: 0px;"><span class="hljs-built_in" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">console</span></span>.<span class="at" style="margin: 0px; padding: 0px;">log</span>(<span class="st" style="margin: 0px; padding: 0px;"><span class="hljs-string" style="margin: 0px; padding: 0px; color: rgb(163, 21, 21);">"Fetch complete"</span></span>)<span class="op" style="margin: 0px; padding: 0px;">;</span>
      <span class="cf" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">return</span></span><span class="op" style="margin: 0px; padding: 0px;">;</span>
    <span class="op" style="margin: 0px; padding: 0px;">}</span>

    <span class="co" style="margin: 0px; padding: 0px;"><span class="hljs-comment" style="margin: 0px; padding: 0px; color: green;">// result.value for fetch streams is a Uint8Array</span></span>
    bytesReceived <span class="op" style="margin: 0px; padding: 0px;">+=</span> <span class="va" style="margin: 0px; padding: 0px;">result</span>.<span class="va" style="margin: 0px; padding: 0px;">value</span>.<span class="at" style="margin: 0px; padding: 0px;">length</span><span class="op" style="margin: 0px; padding: 0px;">;</span>
    <span class="va" style="margin: 0px; padding: 0px;"><span class="hljs-built_in" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">console</span></span>.<span class="at" style="margin: 0px; padding: 0px;">log</span>(<span class="st" style="margin: 0px; padding: 0px;"><span class="hljs-string" style="margin: 0px; padding: 0px; color: rgb(163, 21, 21);">'Received'</span></span><span class="op" style="margin: 0px; padding: 0px;">,</span> bytesReceived<span class="op" style="margin: 0px; padding: 0px;">,</span> <span class="st" style="margin: 0px; padding: 0px;"><span class="hljs-string" style="margin: 0px; padding: 0px; color: rgb(163, 21, 21);">'bytes of data so far'</span></span>)<span class="op" style="margin: 0px; padding: 0px;">;</span>

    <span class="co" style="margin: 0px; padding: 0px;"><span class="hljs-comment" style="margin: 0px; padding: 0px; color: green;">// Read some more, and call this function again</span></span>
    <span class="cf" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">return</span></span> <span class="va" style="margin: 0px; padding: 0px;">reader</span>.<span class="at" style="margin: 0px; padding: 0px;">read</span>().<span class="at" style="margin: 0px; padding: 0px;">then</span>(processResult)<span class="op" style="margin: 0px; padding: 0px;">;</span>
  <span class="op" style="margin: 0px; padding: 0px;">}</span>)<span class="op" style="margin: 0px; padding: 0px;">;</span>
<span class="op" style="margin: 0px; padding: 0px;">}</span>)<span class="op" style="margin: 0px; padding: 0px;">;</span></code></pre></div><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">另外，github上也有使用<code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">Promise+XHR</code>结合的方式实现类fetch的progress效果(当然这跟fetch完全不搭边）可以参考<a href="https://github.com/github/fetch/issues/89#issuecomment-256610849" style="margin: 0px; padding: 0px; color: rgb(0, 0, 0);">这里</a>，具体代码如下：</p><div class="sourceCode" style="padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><pre class="sourceCode javascript" style="margin-top: 10px; margin-bottom: 10px; padding: 0px; white-space: pre-wrap; word-wrap: break-word;"><code class="sourceCode javascript hljs" style="margin: auto; vertical-align: middle; display: block; height: auto; overflow-x: auto; color: rgb(0, 0, 0); padding: 5px !important; line-height: 1.5 !important; font-family: 'Courier New', sans-serif !important; font-size: 12px !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-function" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">function</span></span></span><span class="hljs-function" style="margin: 0px; padding: 0px;"> </span><span class="at" style="margin: 0px; padding: 0px;"><span class="hljs-function" style="margin: 0px; padding: 0px;"><span class="hljs-title" style="margin: 0px; padding: 0px; color: rgb(163, 21, 21);">fetchProgress</span></span></span><span class="hljs-function" style="margin: 0px; padding: 0px;">(<span class="hljs-params" style="margin: 0px; padding: 0px;">url</span></span><span class="op" style="margin: 0px; padding: 0px;">,</span><span class="hljs-function" style="margin: 0px; padding: 0px;"> opts</span><span class="op" style="margin: 0px; padding: 0px;">={},</span><span class="hljs-function" style="margin: 0px; padding: 0px;"><span class="hljs-params" style="margin: 0px; padding: 0px;"> onProgress</span>)</span><span class="op" style="margin: 0px; padding: 0px;">{</span>
    <span class="cf" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">return</span></span> <span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">new</span></span> <span class="at" style="margin: 0px; padding: 0px;"><span class="hljs-built_in" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">Promise</span></span>(<span class="at" style="margin: 0px; padding: 0px;">funciton</span>(resolve<span class="op" style="margin: 0px; padding: 0px;">,</span> reject)<span class="op" style="margin: 0px; padding: 0px;">{</span>
        <span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">var</span></span> xhr <span class="op" style="margin: 0px; padding: 0px;">=</span> <span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">new</span></span> <span class="at" style="margin: 0px; padding: 0px;">XMLHttpRequest</span>()<span class="op" style="margin: 0px; padding: 0px;">;</span>
        <span class="va" style="margin: 0px; padding: 0px;">xhr</span>.<span class="at" style="margin: 0px; padding: 0px;">open</span>(<span class="va" style="margin: 0px; padding: 0px;">opts</span>.<span class="at" style="margin: 0px; padding: 0px;">method</span> <span class="op" style="margin: 0px; padding: 0px;">||</span> <span class="st" style="margin: 0px; padding: 0px;"><span class="hljs-string" style="margin: 0px; padding: 0px; color: rgb(163, 21, 21);">'get'</span></span><span class="op" style="margin: 0px; padding: 0px;">,</span> url)<span class="op" style="margin: 0px; padding: 0px;">;</span>
        <span class="cf" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">for</span></span>(<span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">var</span></span> key <span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">in</span></span> <span class="va" style="margin: 0px; padding: 0px;">opts</span>.<span class="at" style="margin: 0px; padding: 0px;">headers</span> <span class="op" style="margin: 0px; padding: 0px;">||</span> <span class="op" style="margin: 0px; padding: 0px;">{}</span>)<span class="op" style="margin: 0px; padding: 0px;">{</span>
            <span class="va" style="margin: 0px; padding: 0px;">xhr</span>.<span class="at" style="margin: 0px; padding: 0px;">setRequestHeader</span>(key<span class="op" style="margin: 0px; padding: 0px;">,</span> <span class="va" style="margin: 0px; padding: 0px;">opts</span>.<span class="at" style="margin: 0px; padding: 0px;">headers</span>[key])<span class="op" style="margin: 0px; padding: 0px;">;</span>
        <span class="op" style="margin: 0px; padding: 0px;">}</span>

        <span class="va" style="margin: 0px; padding: 0px;">xhr</span>.<span class="at" style="margin: 0px; padding: 0px;">onload</span> <span class="op" style="margin: 0px; padding: 0px;">=</span> e <span class="op" style="margin: 0px; padding: 0px;">=&gt;</span> <span class="at" style="margin: 0px; padding: 0px;">resolve</span>(<span class="va" style="margin: 0px; padding: 0px;">e</span>.<span class="va" style="margin: 0px; padding: 0px;">target</span>.<span class="at" style="margin: 0px; padding: 0px;">responseText</span>)
        <span class="va" style="margin: 0px; padding: 0px;">xhr</span>.<span class="at" style="margin: 0px; padding: 0px;">onerror</span> <span class="op" style="margin: 0px; padding: 0px;">=</span> reject<span class="op" style="margin: 0px; padding: 0px;">;</span>
        <span class="cf" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">if</span></span> (<span class="va" style="margin: 0px; padding: 0px;">xhr</span>.<span class="at" style="margin: 0px; padding: 0px;">upload</span> <span class="op" style="margin: 0px; padding: 0px;">&amp;&amp;</span> onProgress)<span class="op" style="margin: 0px; padding: 0px;">{</span>
            <span class="va" style="margin: 0px; padding: 0px;">xhr</span>.<span class="va" style="margin: 0px; padding: 0px;">upload</span>.<span class="at" style="margin: 0px; padding: 0px;">onprogress</span> <span class="op" style="margin: 0px; padding: 0px;">=</span> onProgress<span class="op" style="margin: 0px; padding: 0px;">;</span> <span class="co" style="margin: 0px; padding: 0px;"><span class="hljs-comment" style="margin: 0px; padding: 0px; color: green;">//上传</span></span>
        <span class="op" style="margin: 0px; padding: 0px;">}</span>
        <span class="cf" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">if</span></span> (<span class="st" style="margin: 0px; padding: 0px;"><span class="hljs-string" style="margin: 0px; padding: 0px; color: rgb(163, 21, 21);">'onprogerss'</span></span> <span class="kw" style="margin: 0px; padding: 0px;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">in</span></span> xhr <span class="op" style="margin: 0px; padding: 0px;">&amp;&amp;</span> onProgress)<span class="op" style="margin: 0px; padding: 0px;">{</span>
            <span class="va" style="margin: 0px; padding: 0px;">xhr</span>.<span class="at" style="margin: 0px; padding: 0px;">onprogress</span> <span class="op" style="margin: 0px; padding: 0px;">=</span> onProgress<span class="op" style="margin: 0px; padding: 0px;">;</span> <span class="co" style="margin: 0px; padding: 0px;"><span class="hljs-comment" style="margin: 0px; padding: 0px; color: green;">//下载</span></span>
        <span class="op" style="margin: 0px; padding: 0px;">}</span>
        <span class="va" style="margin: 0px; padding: 0px;">xhr</span>.<span class="at" style="margin: 0px; padding: 0px;">send</span>(<span class="va" style="margin: 0px; padding: 0px;">opts</span>.<span class="at" style="margin: 0px; padding: 0px;">body</span>)
    <span class="op" style="margin: 0px; padding: 0px;">}</span>)
<span class="op" style="margin: 0px; padding: 0px;">}</span>
<span class="at" style="margin: 0px; padding: 0px;">fetchProgress</span>(<span class="st" style="margin: 0px; padding: 0px;"><span class="hljs-string" style="margin: 0px; padding: 0px; color: rgb(163, 21, 21);">'/upload'</span></span>).<span class="at" style="margin: 0px; padding: 0px;">then</span>(<span class="va" style="margin: 0px; padding: 0px;"><span class="hljs-built_in" style="margin: 0px; padding: 0px; color: rgb(0, 0, 255);">console</span></span>.<span class="at" style="margin: 0px; padding: 0px;">log</span>)</code></pre></div><h2 id="fetch跨域问题" style="margin-top: 20px; margin-bottom: 20px; font-size: 21px; line-height: 1.5; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">fetch跨域问题</h2><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">既然是ajax库，就不可避免与<strong style="margin: 0px; padding: 0px;">跨域</strong>扯上关系；XHR2是支持跨域请求的，只不过要<strong style="margin: 0px; padding: 0px;">满足浏览器端支持<code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">CORS</code>，服务器通过<code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">Access-Control-Allow-Origin</code>来允许指定的源进行跨域</strong>，仅此一种方式。</p><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">与XHR2一样，fetch也是支持跨域请求的，只不过其跨域请求做法与XHR2一样，需要客户端与服务端支持；另外，fetch还支持一种跨域，不需要服务器支持的形式，具体可以通过其<code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">mode</code>的配置项来说明。</p><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">fetch的<code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">mode</code>配置项有3个值，如下：</p><ul style="margin-bottom: 1em; margin-left: 40px; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><li style="padding: 0px; list-style-type: disc;"><p style="margin: 10px auto; padding: 0px;"><code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">same-origin</code>：该模式是不允许跨域的，它需要遵守同源策略，否则浏览器会返回一个error告知不能跨域；其对应的response type为<code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">basic</code>。</p></li><li style="padding: 0px; list-style-type: disc;"><p style="margin: 10px auto; padding: 0px;"><code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">cors</code>: 该模式支持跨域请求，顾名思义它是以CORS的形式跨域；当然该模式也可以同域请求不需要后端额外的CORS支持；其对应的response type为<code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">cors</code>。</p></li><li style="padding: 0px; list-style-type: disc;"><p style="margin: 10px auto; padding: 0px;"><code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">no-cors</code>: 该模式用于跨域请求但是服务器不带CORS响应头，也就是服务端不支持CORS；这也是fetch的特殊跨域请求方式；其对应的response type为<code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">opaque</code>。</p></li></ul><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">针对跨域请求，cors模式是常见跨域请求实现，但是fetch自带的<code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">no-cors</code>跨域请求模式则较为陌生，该模式有一个比较明显的特点：</p><blockquote style="margin-top: 0px; margin-bottom: 0px; padding: 5px 10px; border-style: none none none solid; border-left-width: 5px; border-left-color: rgb(221, 221, 221); border-image-source: initial; border-image-slice: initial; border-image-width: initial; border-image-outset: initial; border-image-repeat: initial; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background: none rgb(255, 255, 255);"><p style="padding: 0px; color: rgb(119, 119, 119);"><strong style="margin: 0px; padding: 0px;">该模式允许浏览器发送本次跨域请求，但是不能访问响应返回的内容，这也是其response type为opaque透明的原因。</strong></p></blockquote><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">这与<code style="margin: 1px 5px; padding: 0px 5px !important; line-height: 1.8; vertical-align: middle; display: inline-block; font-family: &quot;Courier New&quot;, sans-serif !important; font-size: 12px !important; background-color: rgb(245, 245, 245) !important; border: 1px solid rgb(204, 204, 204) !important; border-radius: 3px !important;">&lt;img/&gt;</code>发送的请求类似，只是该模式不能访问响应的内容信息；但是它可以被其他APIs进行处理，例如ServiceWorker。另外，该模式返回的repsonse可以在Cache API中被存储起来以便后续的对它的使用，这点对script、css和图片的CDN资源是非常合适的，因为这些资源响应头中都没有CORS头。</p><p style="margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">总的来说，fetch的跨域请求是使用CORS方式，需要浏览器和服务端的支持。</p><h3 id="参考文献" style="margin-top: 10px; margin-bottom: 10px; font-size: 16px; line-height: 1.5; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">参考文献</h3><ul style="margin-bottom: 1em; margin-left: 40px; padding: 0px; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 'Hiragino Sans GB', Helvetica, Arial, 'Lucida Grande', sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><li style="padding: 0px; list-style-type: disc;"><a href="https://jakearchibald.com/2015/thats-so-fetch/" style="margin: 0px; padding: 0px; color: rgb(0, 0, 0);">thats-so-fetch</a></li><li style="padding: 0px; list-style-type: disc;"><a href="https://segmentfault.com/a/1190000003810652" style="margin: 0px; padding: 0px; color: rgb(0, 0, 0);">传统 Ajax 已死，Fetch 永生</a></li><li style="padding: 0px; list-style-type: disc;"><a href="http://louiszhai.github.io/2016/11/02/fetch/#u5C1D_u8BD5_u4E00_u4E2Afetch" style="margin: 0px; padding: 0px; color: rgb(0, 0, 0);">Fetch进阶指南</a></li><li style="padding: 0px; list-style-type: disc;"><a href="https://jakearchibald.com/2016/streams-ftw/" style="margin: 0px; padding: 0px; color: rgb(0, 0, 0);">2016 - the year of web streams</a></li><li style="padding: 0px; list-style-type: disc;"><a href="http://bubkoo.com/2015/05/08/introduction-to-fetch/" style="margin: 0px; padding: 0px; color: rgb(0, 0, 0);">fetch API 简介</a></li></ul></div><!--WizHtmlContentEnd-->

</div>
</body>

</html>